<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Swift | Intelligence Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Professional Minimalist Loader */
        .loader-ring {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #9333ea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s cubic-bezier(0.6, -0.28, 0.735, 0.045) infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .animate-pulse-slow { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }
        
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
        }

        #loadingOverlay {
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(4px); 
        }
        textarea { resize: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 via-white to-purple-100 min-h-screen p-6 flex flex-col items-center">

    <header class="w-full max-w-4xl flex justify-between items-center mb-10 bg-white/70 backdrop-blur-md px-8 py-6 rounded-3xl shadow-sm border border-white/50">
            
            <div class="border-l-2 border-gray-100 pl-6">
                <h1 class="text-3xl font-black text-gray-900 tracking-tight">Growth <span class="text-purple-600">Swift</span></h1>
                <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Master Control Panel</p>
            </div>
        </div>
        <button onclick="window.history.back()" class="px-5 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl text-xs font-black transition-all active:scale-95 uppercase tracking-widest">
            ← BACK
        </button>
    </header>

    <main class="glass-card p-10 rounded-[2.5rem] shadow-2xl w-full max-w-lg space-y-8 relative overflow-hidden text-center">
        
        <div class="space-y-2">
            <h2 class="text-3xl font-black text-gray-900 tracking-tight">Contact <span class="text-purple-600">Extractor</span></h2>
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Emails, Names & Leads</p>
        </div>

        <div id="forms-container">
            <form id="emailForm" class="space-y-4 text-left">
                <input type="url" id="urlInput_email" placeholder="https://example.com" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 outline-none transition-all" required />
                <input type="number" id="maxPagesInput_email" min="1" max="50" placeholder="Depth (Max Pages, Default: 1)" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 outline-none transition-all" />
                <button type="submit" class="w-full bg-gray-900 text-white p-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-all">Extract Contacts</button>
            </form>
        </div>

        <div id="loadingOverlay" class="absolute inset-0 flex flex-col justify-center items-center z-50 hidden rounded-[2.5rem]">
            <div class="loader-ring mb-4"></div>
            <p id="loadingMessage" class="text-purple-700 font-bold text-sm tracking-wide animate-pulse-slow">Crawling and Extracting...</p>
        </div>

        <div id="error" class="p-4 bg-red-50 text-red-600 rounded-2xl text-sm font-medium hidden"></div>
        
        <div id="result" class="space-y-6 hidden pt-4 text-left">
            <div id="result_email_output" class="space-y-4 pt-4">
                <span class="text-[10px] font-black text-purple-500 uppercase tracking-widest">Extracted Intelligence</span>
                <textarea id="pageOutput_email" rows="12" class="w-full p-4 border border-gray-100 rounded-2xl bg-gray-50/50 font-mono text-xs text-gray-700 leading-relaxed" readonly></textarea>
            </div>
            <button id="downloadBtn" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-xl shadow-emerald-500/20 transition-all hover:bg-emerald-600 active:scale-95">
                Download CSV Report
            </button>
        </div>
    </main>

    <footer class="text-center mt-12 text-gray-400 text-[10px] font-bold uppercase tracking-widest">
        Built with ❤️ by <span class="text-gray-800">Growth Swift</span>
    </footer>

<script>
    // --- GLOBAL STATE ---
    // This variable stores the leads so the download button can access them
    let currentLeads = [];

    const sForm = document.getElementById("scrapeForm"); // If your form ID is different, update this
    const resDiv = document.getElementById("result");
    const errDiv = document.getElementById("error");
    const dlBtn = document.getElementById("downloadBtn");
    const loader = document.getElementById("loadingOverlay");

    // --- CRAWL FUNCTION ---
    async function startCrawl(e) {
        if(e) e.preventDefault();
        
        // Reset UI
        errDiv.classList.add("hidden");
        resDiv.classList.add("hidden");
        dlBtn.classList.add("hidden");
        resDiv.innerHTML = "";
        loader.classList.remove("hidden");

        const urlVal = document.getElementById("crawl-url")?.value || document.getElementById("url")?.value;
        const depthVal = document.getElementById("depth")?.value || 1;

        try {
            const response = await fetch('/api/crawl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: urlVal, max_pages: depthVal })
            });

            if (!response.ok) throw new Error(`Server Error (${response.status})`);

            const data = await response.json();

            if (data.success && data.results.length > 0) {
                currentLeads = data.results; // SAVE DATA FOR DOWNLOAD
                
                // Build the results UI
                let html = `<div class="space-y-4">
                    <span class="text-[10px] font-black text-purple-500 uppercase tracking-widest block">Extracted Intelligence</span>`;
                
                data.results.forEach(lead => {
                    html += `
                        <div class="p-4 bg-white rounded-2xl border border-gray-100 shadow-sm">
                            <p class="text-sm font-bold text-gray-900">${lead.email}</p>
                            <p class="text-[10px] text-gray-400 truncate">${lead.source_page}</p>
                        </div>`;
                });
                html += `</div>`;

                resDiv.innerHTML = html;
                resDiv.classList.remove("hidden");
                dlBtn.classList.remove("hidden");
            } else {
                throw new Error("No leads found on this site.");
            }
        } catch (err) {
            errDiv.innerText = err.message;
            errDiv.classList.remove("hidden");
        } finally {
            loader.classList.add("hidden");
        }
    }

    // --- FIXED DOWNLOAD LOGIC (No more 404) ---
    function downloadLeadsCSV() {
        if (currentLeads.length === 0) {
            alert("No data available to export.");
            return;
        }

        // 1. Build CSV content from the data in memory
        let csvContent = "Email,Source Page\n";
        currentLeads.forEach(lead => {
            csvContent += `"${lead.email}","${lead.source_page}"\n`;
        });

        // 2. Create a Blob (Binary Large Object)
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        // 3. Trigger Download
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "growth_swift_leads.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- EVENT LISTENERS ---
    // Ensure your button ID matches "downloadBtn"
    if (dlBtn) {
        dlBtn.addEventListener("click", downloadLeadsCSV);
    }

    // Re-bind form submission if necessary
    const mainForm = document.querySelector("form");
    if (mainForm) {
        mainForm.addEventListener("submit", startCrawl);
    }
</script>
</body>
</html>